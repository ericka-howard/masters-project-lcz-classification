---
title: "08_winning-random-forest"
author: "Ericka B. Smith"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(randomForest)
library(tidyverse)
library(here)
library(raster)
library(rgdal)
library(forcats)
library(mapproj)
library(broom)
library(ggpubr)
library(viridis)
library(cowplot)
```

```{r}
theme_set(theme_pubclean())
```

Load Data and Functions

```{r}
source(here("R", "get_oa_metrics.R"))
source(here("R", "get_f1_score.R"))
source(here("R", "predict_lcz.R"))
source(here("R", "try_parameter.R"))
train <- readRDS(here("results", "train.rds"))
test <- readRDS(here("results", "test.rds"))
scene_dat <- read_csv(here("data", "scene_info.csv"))
band_info <- read_csv(here("data", "landsat_bands.txt")) %>%
  mutate(Band = factor(Band))
```

Load Model


```{r}
rf <- readRDS(here("results", "winning_rf.rds"))
```

```{r}
#rf <- randomForest(lcz ~ ., data=train, ntree=125, importance=TRUE)
```


Predict on Test Data

```{r}
predicted <- predict_lcz(test, rf)
```

Get metrics

```{r}
oa <- get_oa_metrics(predicted)
f1 <- get_f1_score(predicted, lcz, lcz_predicted)
```


# Make Plots

```{r fig.height=5}
imp_plot <- varImpPlot(rf)
class(imp_plot)

get_date <- function(scene_num){
  date <- scene_dat$Date[which(scene_dat$Scene==scene_num)]
}

rf$importance %>%
  as.data.frame() %>%
  rownames_to_column(var = "Predictor Variable") %>%
  separate(
    col = `Predictor Variable`,
    into = c("Band", "Scene"),
    sep = -1,
    remove = F
  ) %>%
  mutate(Band = parse_number(Band),
         Band = factor(Band),
         Scene = as.double(Scene)) %>%
  left_join(scene_dat, by="Scene") %>%
  left_join(band_info, by="Band") %>%
  mutate(Scenes = paste("Scene", Scene, ":\n", Date),
         Band = paste("Band", Band, ":\n", Description)) %>%
  ggplot() +
  geom_bar(aes(x = MeanDecreaseGini, y = Band, fill = Scenes),
           stat = 'identity',
           position = "dodge",
           color="black") +
  facet_grid(Band~., scales="free")+
  scale_fill_viridis(discrete = T) +
  theme(legend.position = "right",
        legend.title = element_blank(),
        strip.text=element_blank()) +
  labs(title = "Importance Measures for Each Predictor Variable",
       x = "Mean Decrease in Gini Impurity",
       y="")

ggsave(here("results/plots", "png_importance_barplot_ntree125.png"))
```


```{r fig.height=4}
urban <-
  c("F1-10",
    "F1-8",
    "F1-6",
    "F1-5",
    "F1-4",
    "F1-3",
    "F1-2",
    "F1-1",
    "OA-URB")
natural <- c("F1-17", "F1-14", "F1-13", "F1-12", "F1-11", "OA-NAT")

prep_and_plot <- function(dat, metric_name) {
  dat %>%
    rename_at(vars(everything()), ~ toupper(gsub("_", "-", .x))) %>%
    pivot_longer(everything(), names_to = "Metric") %>%
    mutate(
      Type = case_when(
        Metric %in% urban ~ "Urban",
        Metric %in% natural ~ "Natural",
        TRUE ~ "Overall"
      ),
      Metric = fct_reorder(Metric, value)
    ) %>%
    ggplot() +
    geom_bar(aes(x = value, y = Metric, fill = Type),
             color = "white",
             stat = 'identity') +
    scale_fill_viridis(discrete = T, option = "cividis") +
    theme_pubr()+
    # labs(
    #   title = "",
    #   subtitle = "",
    #   x = "",
    #   y = metric_name
    # ) +
    coord_cartesian(xlim = c(0, 1)) +
    theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
          axis.text = element_text(size = 9),
          axis.title = element_blank())
  
}

oa_plot <- prep_and_plot(oa, "")
f1_plot <- prep_and_plot(f1, "") + facet_grid(Type ~ ., scales = "free")

# extract the legend from one of the plots
legend <- get_legend(
  oa_plot + theme(
    legend.position = "top",
    legend.box.margin = ggplot2::margin(0, 0, 0, 0)
  ))
oa_just_plot <- oa_plot + theme(legend.position = "none")
f1_just_plot <-
  f1_plot + theme(legend.position = "none", strip.text = element_blank())

left_side <- plot_grid(legend, oa_just_plot, rel_heights = c(0.1, 1), nrow=2)
left_side

facet_pair <-
  plot_grid(
    left_side,
    f1_just_plot,
    ncol = 2,
    rel_widths = c(0.75, 1)
    
  )
annotate_figure(facet_pair,
                top = text_grob(
                  "\nValidation Metrics for Test Dataset\n",
                  face = "bold",
                  size = 14
                ))
ggsave(here(
  "results/plots",
  "png_test_set_validation_metrics_barplot_separated.png"
))
```


Save Random Forest

```{r}
#saveRDS(rf, here("results", "winning_rf.rds"))
```

