---
title: "07_iterating-over-tuning-parameters"
author: "Ericka B. Smith"
date: "2/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(randomForest)
library(tidyverse)
library(here)
library(raster)
library(rgdal)
library(purrr)
library(mapproj)
library(forcats)
source(here("R", "get_oa_metrics.R"))
source(here("R", "get_f1_score.R"))
source(here("R", "predict_lcz.R"))
```

## Load Data

```{r}
train <- readRDS(here("results", "train.rds"))
test <- readRDS(here("results", "test.rds"))
```

# Start with default mtry=6

## Create & Evaluate Model

```{r}
ntrees <- 500
rf <- randomForest(lcz ~ ., data=train, ntree=ntrees, keep.inbag = T, keep.forest=T)
print(rf)
```
## Calculate OOB Error rate

```{r}
inbag <- rf$inbag
ind_tree_preds <- predict(rf, predict.all=TRUE)
correct <- ind_tree_preds == train$lcz
(length(correct)-sum(correct))/length(correct)
```



```{r}
is_oob_vote_correct <- function(pixel_row) {
  # get list of inbag values for a given row/observation
  bag <- inbag[pixel_row, ]
  # find where that row/observation is out of bag
  index_vals <- which(bag == 0)
  # use our list of individual tree predictions to extract what the predicted 
  # value for that row/observation is every time it's out of bag
  votes <- ind_tree_preds[pixel_row, index_vals]
  # count up those votes
  ordering_votes <- votes %>% fct_inorder() %>% levels()
  # get the highest number of votes
  winner <- ordering_votes[1]
  # is that winning class correct?
  correct <- winner == train$lcz[pixel_row]
  return(correct)
}
```

```{r}
# vote <- NULL
# correct <- NULL
# is_correct <- NULL

is_correct <-map_lgl(1:nrow(train), ~is_oob_vote_correct(.x))
oob_error_rate <- 1-(sum(is_correct, na.rm=T)/length(is_correct))
```




original
```{r}
getting_accuracy_metrics_oob <- function(x){
  bag <- inbag[,x]
  index_vals <- as.numeric(names(bag[which(bag==0)]))
  lcz_predicted <- ind_tree_preds[index_vals, x]
  oob_prediction <- cbind(train[index_vals,], lcz_predicted)
  oas <- get_oa_metrics(oob_prediction)
  return(oas)
  }
```


```{r}
metrics_galore <- map_dfr(1:5, ~getting_accuracy_metrics_oob(.x))
```

look here for oob error info [here](https://www.stat.berkeley.edu/~breiman/RandomForests/cc_home.htm)

