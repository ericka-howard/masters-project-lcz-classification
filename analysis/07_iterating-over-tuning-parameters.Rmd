---
title: "07_iterating-over-tuning-parameters"
author: "Ericka B. Smith"
date: "2/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(randomForest)
library(tidyverse)
library(here)
library(raster)
library(rgdal)
library(purrr)
library(mapproj)
library(forcats)
library(reshape2)
library(viridis)
source(here("R", "get_oa_metrics.R"))
source(here("R", "get_f1_score.R"))
source(here("R", "predict_lcz.R"))
source(here("R", "try_parameter.R"))
theme_set(theme_light())
```

## Load Data

```{r}
train <- readRDS(here("results", "train.rds"))
test <- readRDS(here("results", "test.rds"))
```


## Replicate OOB Error Rate

```{r}
## make model
#rf <- randomForest(lcz ~ ., data=train, ntree=50, keep.inbag = T)
## Calculate OOB Error rate
# print(rf)
# # gets list of OOB prediction for each row (each pixel observation)
# ind_tree_preds <- predict(rf, predict.all=TRUE)
# # checks when OOB prediction is the same as true LCZ value
# correct <- ind_tree_preds == train$lcz
# # calculate OOB error rate
# (length(correct)-sum(correct))/length(correct)
```

OA is the same as 1-OOB Error Rate.

## Iterating over mtry

using `try_parameter(dat, ...)` function

```{r}
metrics <- try_parameter(train, mtry=5)
```

```{r}
ntree_list <- map_dfr(seq(from=5, to=500, by=10), ~try_parameter(train, ntree=.x))
```


```{r}
ntree_list %>%
  filter(ntree, oa, oa_urb, oa_nat) %>%
  melt(id.vars= "ntree", measure.vars=c("oa", "oa_urb", "oa_nat"), value.name = "Accuracy", variable.name="Metric") %>%
  ggplot()+
  geom_point(aes(x=ntree, y=Accuracy, color=Metric))+
  geom_smooth(aes(x=ntree, y=Accuracy, color=Metric), se=F)+
  ggtitle("Overall Accuracy Metrics for varying numbers of trees",
          subtitle="Calculations are based on out-of-bag sample")+
  xlab("Number of Trees (ntree)")+
  scale_color_viridis(discrete=T,
                      breaks=c("oa", "oa_urb", "oa_nat"),
                      labels=c("Overall", "Urban", "Natural"))
```

```{r}
# ntree_list %>%
#   filter %>%
#   melt(id.vars= "ntree", measure.vars=c("oa", "oa_urb", "oa_nat"), value.name = "Accuracy", variable.name="Metric") %>%
#   ggplot()+
#   geom_point(aes(x=ntree, y=Accuracy, color=Metric))+
#   geom_smooth(aes(x=ntree, y=Accuracy, color=Metric), se=F)+
#   ggtitle("Overall Accuracy Metrics for varying numbers of trees",
#           subtitle="Calculations are based on out-of-bag sample")+
#   xlab("Number of Trees (ntree)")+
#   scale_color_viridis(discrete=T,
#                       breaks=c("oa", "oa_urb", "oa_nat"),
#                       labels=c("Overall", "Urban", "Natural"))
# ggsave(here("results/plots", "varied_ntree_oas.tiff"))
```



